on:
  push:
    branches:
      - master
env:
  SemVer: 2.0.1
  Configuration: Release
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.100
    - uses: nuget/setup-nuget@v1.0.2
      with:
        nuget-version: 5.x
    - run: nuget restore
    - uses: microsoft/setup-msbuild@v1
    - name: build
      run: msbuild /p:Configuration=${{ env.Configuration }} /p:"Platform=Any CPU" /p:Version=${{ env.SemVer }}.${{ GITHUB.RUN_NUMBER }} /p:InformationalVersion=${{ env.SemVer }}'
      shell: cmd
    - run: dotnet test -c Release --no-build src/DotNetCore.Tests/DotNetCore.Tests.csproj
    # glob pattern does not seem to work due to mix of .Net Core & Full Framework tests
    - run: dotnet vstest "src\testmodules\LocalizationTests\bin\${{ env.Configuration }}\net46\LocalizationTests.dll" --Framework:".NETFramework,Version=4.6"
    - run: dotnet vstest "src\ResourceEmbedder.Core.Tests\bin\${{ env.Configuration }}\net46\ResourceEmbedder.Core.Tests.dll" --Framework:".NETFramework,Version=4.6"
    - run: dotnet vstest "src\ResourceEmbedder.MsBuild.Tests\bin\${{ env.Configuration }}\net46\ResourceEmbedder.MsBuild.Tests.dll" --Framework:".NETFramework,Version=4.6"
    - run: |
        dotnet pack src/ResourceEmbedder.Core/ResourceEmbedder.Core.csproj -c ${{ env.Configuration }} -o release/packages -p:PackageVersion=${{ env.SemVer }} --no-build
        dotnet pack src/ResourceEmbedder.MsBuild/ResourceEmbedder.MsBuild.csproj -c ${{ env.Configuration }} -o release/packages -p:PackageVersion=${{ env.SemVer }} --no-build
    - uses: actions/upload-artifact@v1
      with:
        name: nuget
        path: release/packages
